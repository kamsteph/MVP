import 'dart:convert';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:web_socket_channel/web_socket_channel.dart';

import 'PentestNotifier.dart';

class EventBusBridge {
  final WidgetRef ref;
  final WebSocketChannel channel;

  EventBusBridge(this.ref, this.channel) {
    channel.stream.listen((event) {
      final data = jsonDecode(event);

      final String? type = data['event'];
      final payload = data['payload'];

      if (type == "scan_progress") {
        ref.read(pentestProvider.notifier).updatePentest(
          payload["task_id"],
          progressMessage: payload["message"],
        );
      } else if (type == "scan_complete") {
        ref.read(pentestProvider.notifier).updatePentest(
          payload["task_id"],
          status: payload["status"],
          progressMessage: "Scan finished",
        );
      }
    });
  }
}
