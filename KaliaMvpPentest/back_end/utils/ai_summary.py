import requests
import json

def generate_ai_summary(scan_results):
    if not scan_results:
        return "No results found in the scan."

    formatted = "\n".join(
        f"- Port: {e.port}, Proto: {e.protocol}, Service: {e.service}, "
        f"State: {e.state}, Version: {e.version or 'N/A'}"
        for e in scan_results
    )

    prompt_text = f"""
You are a cybersecurity analyst.

Here is the output of a network scan:
{formatted}

Please provide:
1. A short summary of the detected open services and ports.
2. The associated risks.
3. Mitigation recommendations.
"""

    response = requests.post(
        "http://localhost:11434/api/generate",  # Ollama local endpoint
        json={"model": "mistral", "prompt": prompt_text}
    )

    if response.status_code != 200:
        raise RuntimeError(f"Ollama request failed: {response.text}")

    # Stream response lines
    summary = ""
    for line in response.text.strip().splitlines():
        obj = json.loads(line)
        summary += obj.get("response", "")
    return summary.strip()
