# new_module/database.py
from pymongo import MongoClient
import os
from dotenv import load_dotenv
from typing import List

# Load environment variables from .env file
load_dotenv()

class DatabaseManager:
    """
    Manages all database connections for the AI Pentest Platform.
    Using MongoDB as the primary data store.
    """
    def __init__(self):
        self.client = MongoClient("mongodb+srv://kamsteph:Test1234@kaliacluster.mzupz.mongodb.net/?retryWrites=true&w=majority&appName=kaliaCluster")
        self.db = self.client.get_database("ai_pentest_dbs")

        # Collections
        self.standard_db = self.db.get_collection("standard_db")
        self.save_codebase=self.db.get_collection("save_codebase")
        self.learning_data = self.db.get_collection("stage_learning_area")
        self.adb_collection = self.db.get_collection("augmented_database") #Threat Intel DB
        self.agent_memory=self.client.get_database("agent_memory")
        self.capability_matrix=self.db.get_collection("capability_matrix")
        self.telemetry_logs=self.db.get_collection("telemetry_logs")

    def get_logs(self):
        return self.telemetry_logs.find({})

    def save_scan_result(self, result: dict):
        """Saves a scan result to the 'scan_results' collection."""
        return self.standard_db.insert_one(result)

    def get_unprocessed_results(self):
        """Retrieves scan results that have not yet been processed by the L-Region."""
        return self.standard_db.find({"l_region_processed": False})

    def mark_as_processed(self, result_id):
        """Marks a result as processed by the L-Region."""
        self.standard_db.update_one({"_id": result_id}, {"$set": {"l_region_processed": True}})

    def save_learning_data(self, data: dict):
        """Saves a new learning point or exploit to the 'learning_data' collection."""
        return self.learning_data.insert_one(data)

    def get_all_threat_intel(self):
        """Retrieves all threat intelligence from the ADB."""
        return self.adb_collection.find({})

    def save_memory_state(self, memory: dict):
        return self.agent_memory.insert_one(memory)

    def get_memory_state(self, target_ip: str):
        return self.agent_memory.find_one({"target_ip": target_ip})

    def save_codebase(self, memory: dict):
        return self.save_codebase.insert_one(memory)

    def save_tool_capability(self, tool_doc: dict):
        """Insert or update a tool capability document."""
        return self.capability_matrix.update_one(
            {"tool": tool_doc["tool"]},
            {"$set": tool_doc},
            upsert=True
        )

    def get_tool_capabilities(self, surfaces: List[str] = None):
        """Retrieve tools, optionally filtered by supported attack surfaces."""
        if surfaces:
            return list(self.capability_matrix.find({"surfaces": {"$in": surfaces}}))
        return list(self.capability_matrix.find({}))

    def query(self, collection: str, filter_query: dict = None, projection: dict = None):
        """Run a query on any collection."""
        filter_query = filter_query or {}
        coll = self.db.get_collection(collection)
        return list(coll.find(filter_query, projection or {}))

    def find_one(self, collection: str, filter_query: dict):
        """Find a single document by filter."""
        coll = self.db.get_collection(collection)
        return coll.find_one(filter_query)

    def update(self, collection: str, filter_query: dict, update_doc: dict, upsert: bool = True):
        """Update (or upsert) a document."""
        coll = self.db.get_collection(collection)
        return coll.update_one(filter_query, {"$set": update_doc}, upsert=upsert)

    def insert_many(self, collection: str, docs: list):
        """Insert many documents into a collection."""
        if not docs:
            return None
        coll = self.db.get_collection(collection)
        return coll.insert_many(docs)

    @property
    def adb(self):
        """Shortcut to the augmented database (ADB) collection."""
        return self.adb_collection
