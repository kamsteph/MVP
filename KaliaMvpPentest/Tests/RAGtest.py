import os
import pytest
from dotenv import load_dotenv

from back_end.pentest_research import PentestResearchRAG

load_dotenv()
@pytest.fixture(scope="module")
def rag():
    # Make sure the API key is set
    assert os.getenv("OPENAI_API_KEY"), "OPENAI_API_KEY not set in environment"
    rag = PentestResearchRAG(persist_dir="../back_end/test_rag_store")
    return rag

def test_add_and_query(rag):
    # 1. Add some docs
    docs = [
        {"text": "Nmap is a network scanning tool for reconnaissance."},
        {"text": "Metasploit is used for exploitation."},
    ]
    rag.add_documents(docs)

    # 2. Run a query
    response = rag.research("What is Nmap used for?")
    assert isinstance(response, str)
    assert "scan" in response.lower() or "reconnaissance" in response.lower()

def test_empty_query(rag):
    response = rag.research("This is something unrelated.")
    assert isinstance(response, str)
